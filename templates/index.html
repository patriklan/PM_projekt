{% extends 'base.html' %}
{% block body %}
<div>
    <h1>Matrice</h1>
    <form id="matrix-settings">
        <label for="rowsA">Redovi A:</label>
        <input type="number" id="rowsA" name="rowsA" min="1" max="10" value="2">
        <label for="colsA">Stupci A:</label>
        <input type="number" id="colsA" name="colsA" min="1" max="10" value="2">
        <label for="rowsB">Redovi B:</label>
        <input type="number" id="rowsB" name="rowsB" min="1" max="10" value="2">
        <label for="colsB">Stupci B:</label>
        <input type="number" id="colsB" name="colsB" min="1" max="10" value="2">
        <button type="button" id="updateMatrices">Osvježi matrice</button>
    </form>

    <h2>Matrica A</h2>
    <div id="matrixAContainer"></div>
    <button id="transposeA">Transponiraj A</button>
    <p id="symmetryA">Simetrija: </p>

    <h2>Matrica B</h2>
    <div id="matrixBContainer"></div>
    <button id="transposeB">Transponiraj B</button>
    <p id="symmetryB">Simetrija: </p>

    <h2>Rezultat</h2>
    <div id="resultContainer"></div>

    <div>
        <button id="add">Zbroji</button>
        <button id="subtract">Oduzmi</button>
        <button id="multiply">Pomnožsi</button>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function createMatrixInputs(containerId, rows, cols, matrixData = null) {
        const container = $(`#${containerId}`);
        container.empty();
        for (let i = 0; i < rows; i++) {
            let row = $('<div class="matrix-row"></div>');
            for (let j = 0; j < cols; j++) {
                const value = matrixData ? matrixData[i][j] : 0;
                row.append(`<input type="number" class="matrix-input" data-row="${i}" data-col="${j}" value="${value}">`);
            }
            container.append(row);
        }
    }

    function getMatrixData(containerId) {
        const inputs = $(`#${containerId} .matrix-input`);
        const matrix = [];
        inputs.each(function () {
            const row = parseInt($(this).data('row'));
            const col = parseInt($(this).data('col'));
            if (!matrix[row]) matrix[row] = [];
            matrix[row][col] = parseFloat($(this).val());
        });
        return matrix;
    }

    function updateMatrix(containerId, rows, cols) {
        $.post('/update_matrix', { rows, cols }, function (data) {
            createMatrixInputs(containerId, rows, cols, data);
            updateMatrixInfo(containerId);
        });
    }

    function updateMatrixInfo(containerId) {
        const matrix = getMatrixData(containerId);
        $.ajax({
            url: '/matrix_info',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ matrix }),
            success: function (data) {
                const symmetryId = containerId === 'matrixAContainer' ? '#symmetryA' : '#symmetryB';
                $(symmetryId).text('Simetrija: ' + data.symmetry);
            }
        });
    }

    $(document).ready(function () {
        $('#updateMatrices').click(function () {
            const rowsA = $('#rowsA').val();
            const colsA = $('#colsA').val();
            const rowsB = $('#rowsB').val();
            const colsB = $('#colsB').val();
            updateMatrix('matrixAContainer', rowsA, colsA);
            updateMatrix('matrixBContainer', rowsB, colsB);
        });

        $('#transposeA').click(function () {
            const matrix = getMatrixData('matrixAContainer');
            $.ajax({
                url: '/transpose',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ matrix }),
                success: function (data) {
                    createMatrixInputs('matrixAContainer', data.length, data[0].length, data);
                    updateMatrixInfo('matrixAContainer');
                }
            });
        });

        $('#transposeB').click(function () {
            const matrix = getMatrixData('matrixBContainer');
            $.ajax({
                url: '/transpose',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ matrix }),
                success: function (data) {
                    createMatrixInputs('matrixBContainer', data.length, data[0].length, data);
                    updateMatrixInfo('matrixBContainer');
                }
            });
        });

        $('#add, #subtract, #multiply').click(function () {
            const operation = $(this).attr('id');
            const matrixA = getMatrixData('matrixAContainer');
            const matrixB = getMatrixData('matrixBContainer');
            $.ajax({
                url: '/operate',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ operation, matrixA, matrixB }),
                success: function (data) {
                    createMatrixInputs('resultContainer', data.length, data[0].length, data);
                },
                error: function (xhr) {
                    alert('Error: ' + xhr.responseJSON.error);
                }
            });
        });

        $('#matrixAContainer, #matrixBContainer').on('change', '.matrix-input', function () {
            const containerId = $(this).closest('div').attr('id');
            updateMatrixInfo(containerId);
        });
    });
</script>
{% endblock %}
