{% extends 'base.html' %}

{% block head %}
<style>
    .matrix-container { display: flex; gap: 20px; flex-wrap: wrap; }
    .matrix { text-align: center; }
    table { margin-bottom: 10px; }
</style>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const updateMatrix = (matrixName) => {
            const rows = document.querySelectorAll(`.matrix[data-name="${matrixName}"] table tr`);
            const matrix = Array.from(rows).map(row => 
                Array.from(row.querySelectorAll('input')).map(input => parseFloat(input.value) || 0)
            );

            fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: `update_${matrixName}`, matrix })
            }).then(response => response.json()).then(data => {
                if (matrixName === 'a') {
                    renderTransposedMatrix('ta', data.matrix_ta, data.cola, data.rowa);
                } else if (matrixName === 'b') {
                    renderTransposedMatrix('tb', data.matrix_tb, data.colb, data.rowb);
                }
            });
        };

        const renderTransposedMatrix = (matrixName, matrix, rows, cols) => {
            const container = document.querySelector(`.matrix.transposed[data-name="${matrixName}"] table`);
            container.innerHTML = '';
            for (let i = 0; i < rows; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < cols; j++) {
                    const cell = document.createElement('td');
                    cell.textContent = matrix[i][j];
                    row.appendChild(cell);
                }
                container.appendChild(row);
            }
        };

        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', e => {
                const matrixName = e.target.closest('.matrix').dataset.name;
                updateMatrix(matrixName);
            });
        });

        document.querySelectorAll('button[data-action]').forEach(button => {
            button.addEventListener('click', e => {
                e.preventDefault();
                const action = button.dataset.action;

                fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                }).then(response => response.json()).then(data => {
                    if (action === 'TrA') {
                        renderTransposedMatrix('ta', data.matrix_ta, data.cola, data.rowa);
                    } else if (action === 'TrB') {
                        renderTransposedMatrix('tb', data.matrix_tb, data.colb, data.rowb);
                    } else {
                        location.reload();
                    }
                });
            });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });
    });
</script>
{% endblock %}

{% block body %}
<h1>Matrice</h1>

<div class="matrix-container">
    <div class="matrix" data-name="a">
        <h2>Matrica A</h2>
        <form>
            <table>
                {% for row in range(rowa) %}
                    <tr>
                        {% for col in range(cola) %}
                            <td><input size="3" type="number" name="a_{{ row }}_{{ col }}" value="{{ matrix_a[row][col] }}" /></td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            <button type="button" data-action="add_row_a">Dodaj Red</button>
            <button type="button" data-action="remove_row_a">Makni Red</button>
            <button type="button" data-action="add_column_a">Dodaj Stupac</button>
            <button type="button" data-action="remove_column_a">Makni Stupac</button>
        </form>
    </div>

    <div class="matrix" data-name="b">
        <h2>Matrica B</h2>
        <form>
            <table>
                {% for row in range(rowb) %}
                    <tr>
                        {% for col in range(colb) %}
                            <td><input size="3" type="number" name="b_{{ row }}_{{ col }}" value="{{ matrix_b[row][col] }}" /></td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            <button type="button" data-action="add_row_b">Dodaj Red</button>
            <button type="button" data-action="remove_row_b">Makni Red</button>
            <button type="button" data-action="add_column_b">Dodaj Stupac</button>
            <button type="button" data-action="remove_column_b">Makni Stupac</button>
        </form>
    </div>

    <div class="matrix transposed" data-name="ta">
        <h2>Transponirana A</h2>
        <table></table>
    </div>

    <div class="matrix transposed" data-name="tb">
        <h2>Transponirana B</h2>
        <table></table>
    </div>
</div>

<form>
    <button type="button" data-action="TrA">Transponiraj A</button>
    <button type="button" data-action="TrB">Transponiraj B</button>
</form>
{% endblock %}
